# Blender_L4D2_Character_Tools
这是一个旨在提升求生之路2人物Mod制作效率的插件！(*´▽｀)ノノ

## 特性
- 运用预设的骨骼映射关系快速进行骨骼对齐与合并
- 插入动作关键帧辅助生成VRD文本
- 编写抖动骨骼参数，支持批量设置，文本输入输出，预设管理
- 通过操控原始形态键的混合数值生成适配自己面部规则的表情集

## 安装方式
1. 在[发行版](https://github.com/Saberafter/Blender_L4D2_Character_Tools/releases)页面下载最新的zip压缩包
2. 打开Blender，找到编辑(Edit)-偏好设置(Preferences)-插件(Add-ons)
3. 在插件(Add-ons)选项卡中安装(Install)这个压缩包并启用(√)

## 使用说明
📌 **操作面板**: 

- 安装启用插件后在N键侧栏中可以找到以💝作为侧栏名字的插件，点击💝进入插件面板
<p align="center">
  <img src="assets/0.png" alt="操作面板"/>
</p>

📌 **对齐骨骼**: 

- 设置好官方骨架和自定义骨架，点击对齐骨骼，官方骨架的主要骨骼将被自动添加复制位置的骨骼约束，约束的目标骨骼是官骨对应部位骨骼，这些对应关系均在骨骼映射字典里编入过。
![对齐骨骼](assets/1.gif)

📌 **骨骼映射管理**: 

- 骨骼映射管理第一栏是官方骨架的主要骨骼列表，每一项骨骼都绑定着第二栏自定义骨列表中的骨骼列表(骨骼名会经过去符号和转小写处理)，比如官骨的盆骨就绑定着hips以及pelvis，这些即是对骨和嫁接过程中使用的骨骼映射关系。
<p align="center">
  <img src="assets/2.png" alt="编写骨骼映射字典"/>
</p>

- 选中自定义骨架并进入姿态模式，会多出第三行"骨骼名称",在第一行"官方骨骼列表"以及这儿选择好需要绑定映射关系的一组官骨和自定义骨，点击添加，我们就可以给当前骨骼映射关系添加一项需要绑定映射关系的骨骼名，新增骨骼会在第二栏中立刻刷新展示。这里的设计初衷是为了当有预设字典里没有包含的骨骼名时，也可以自由进行字典的编辑与维护，做到全局操作都在blender中完成。
![插件使用说明](assets/3.gif)

📌 **嫁接骨骼**: 
- 对骨补充：使用对齐骨骼创建一批骨骼约束后，先设置一次静置姿势定位姿态，然后移除骨骼约束完成对齐操作的收尾。
![插件使用说明](assets/4.gif)
- 从这里开始可以分为两种嫁接流程，一种是先把自定义骨骼重命名为标准官骨命名，然后利用插件的合骨把同名骨骼及权重合并至官方骨架中，这个方法可以观看[轻语老师的视频](https://www.bilibili.com/video/BV1414y1U7JX?t=432.4&p=3)，我以上面讲过的骨骼映射字典为基础设置了一个<span style="color:red">重命名骨骼</span>的功能用来代替重命名脚本。另一种方法是保留原骨骼重新设置父子级关系。两种方法的区别只有保不保留骨骼，视情况或者喜好来用就行。
- 接下来演示一下这个流程使用的嫁接功能，这个功能有两个主要模式和一个特殊模式。
  1. 当选中某一些骨骼时，只对这些骨骼进行嫁接操作。
  2. 当没有选中骨骼时，默认对全体骨骼进行嫁接操作。
  3. 特别的，当多选骨骼时只要其中包含官骨，则其他被选中骨骼不管有没有存在于映射关系中，均会成为这根官骨的子级。
- 原理仍然是利用了上面设置过的骨骼映射关系，同时还加入了一个距离判定，只要有几乎完全重合的骨骼，就会在其中设置父子级关系。
![插件使用说明](assets/5.gif)
![插件使用说明](assets/6.gif)


📌 **VRD**: 
- 关于借助人物动作辅助生成VRD文本的原理就不讲了，这里主要讲解使用插件生成VRD文本的流程过一遍插件的VRD相关功能。
1. 选中需要制作VRD的官方骨架，点击<span style="color:red">生成VRD动作</span>，会自动为驱动骨骼插帧创建预置的两个名为"VRD"和"VRD_Foot"的动作。"VRD"用来制作裙子VRD以及修正持枪动作。"VRD_Foot"用来修复穿着高跟鞋人物的IK。当然我们按需自己创建动作或在此基础上调整动作也是可以的。剩下的就是在驱动骨骼的动作参考下给程序骨骼插帧。
![插件使用说明](assets/7.gif)
2. 完成动作插帧后在VRD项目管理中新建项目，VRD动作数量=VRD项目数量，之后在列表中的右侧给每一栏VRD项目绑定好对应的VRD动作。这里解释一下，因为假如要得到正确的足VRD坐标，和动过腿的动作共用一个动作肯定是不行的(虽然可以断开，但操作麻烦不方便修改)，而手和腿没有冲突可以放一个动作里，所以得看情况分开处理VRD的辅助动作。
3. 每个VRD项目会绑定一组程序骨和驱动骨的列表。列表左右同一行互相对应。程序骨骼列表每一栏右侧的数字即VRD参数里的第一组角度。
4. 添加骨骼设置完毕后，在下方设置导出路径，选择想使用的文本类型导出。
![插件使用说明](assets/8.gif)

📌 **飘骨**: 
- 飘骨工具主要以骨骼列表为中心进行飘骨参数的维护。在列表中添加骨骼之后，选中列表中的任一骨骼，右侧打开参数面板，下方会弹出当前骨骼各类抖动参数的详细设置，碍于UI面积只做了两大类抖动参数。完成参数设置后，导出的文本会自动输出为能被编译器正确识别的文本格式。下面讲解插件中提高抖动参数编辑效率的一系列功能。

1. 骨骼列表左上方全选反选按钮旁边有一个同步按钮，可以让列表的选中状态和3D视图的选中状态同步，多选状态下每次点击按钮都会跳转至下一项被选中骨骼，方便进行从3D视图转到骨骼列表的直观浏览。
![插件使用说明](assets/9.gif)
2. 同步按钮旁边的预设功能可以保存当前配置好的抖动参数成为预设。同时也支持给列表里多选中的骨骼批量载入预设。
![插件使用说明](assets/10.gif)

3. 右侧参数面板开关下面的扳手按钮可以对参数批量设置，支持多选骨骼批量调整抖动参数数值，也可以通过设置最小最大值智能递增或递减数值。

4. 右侧最后一个按钮可以用来导入外部文件复制进剪贴板的参数，换句话说就是能把标准格式的抖动参数格式化并输入进当前面板展示参数。
<p align="center">
  <img src="assets/11.gif" alt="图片1描述" width="400px" />
  <img src="assets/12.gif" alt="图片2描述" width="400px" />
</p>

📌 **表情**: 
- 表情工具的核心逻辑是基于自定义原模的形态键，通过混合这些形态键变形数值的方式得到适配我们自己面部规则的一套新形态键。而因为MMD模型之间和VRC模型之间的形态键名称一般都是共通的，这正好可以让我们能通过记录形态键名称和变形数值的方式，写一套可以一直复用的形态键混合字典。
- 初次启用插件时已经内置了一些形态键混合字典，这里的对应关系有些类似骨骼映射字典。下拉菜单里的AU表情即为我们最终需要的形态键，它们分别绑定了不同的形态键组合，一个AU表情可能对应一套或多套可以用来混合的形态键组合。而这些内容全都可以在blender中进行编辑。这里图文简单展示一下流程：
  1. 使用捕捉功能记录形态键，添加进混合表情集所需的形态键列表中
  2. 使用批量创建功能，选择我们的面部规则需要的表情以及顺序创建形态键
  3. 整理形态键，只保留使用插件生成的表情

https://github.com/Saberafter/Blender_L4D2_Character_Tools/assets/13.mp4



## 致谢
- 抹茶芝士✰：对骨脚本&灵感来源
- 残剑斩龙：3DMAX的VRD插件思路
- [SourceOps](https://github.com/bonjorno7/SourceOps)：获取骨骼位置/旋转坐标
- [BoneAnimCopy](https://github.com/kumopult/blender_BoneAnimCopy)：骨骼映射思路
- 发布人物制作教程的作者们

这个插件是为了帮助"求生之路2"的Mod制作者们更高效地进行制作工作。希望这个插件可以使他们的工作变得更轻松。

如果你对插件有使用问题或者功能建议，欢迎你在Github上提交issue。

# Blender_L4D2_Character_Tools
这是一个旨在提升求生之路2人物Mod制作效率的插件。

## 特性
- 运用预设的骨骼映射关系快速进行骨骼对齐与合并
- 插入动作关键帧辅助生成VRD文本
- 快速编写抖动骨骼参数，支持批量设置，导入导出，保存预设
- 通过操控原始形态键的混合数值生成适配你面部规则的表情集

## 安装方式
1. 在[releases](https://github.com/Saberafter/Blender_L4D2_Character_Tools/releases)页面下载最新的zip压缩包
2. 打开Blender，找到编辑(Edit)-偏好设置(Preferences)-插件(Add-ons)
3. 在插件(Add-ons)选项卡中安装(Install)这个压缩包并启用(√)

## 使用说明
📌 **操作面板**: 

- 安装启用插件后在N键侧栏中可以找到以💝作为侧栏名字的插件，点击💝进入插件面板
<p align="center">
  <img src="https://private-user-images.githubusercontent.com/46404382/318287921-a54cbdcd-2190-4908-b2cd-c88692273c86.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTE5MDUzODcsIm5iZiI6MTcxMTkwNTA4NywicGF0aCI6Ii80NjQwNDM4Mi8zMTgyODc5MjEtYTU0Y2JkY2QtMjE5MC00OTA4LWIyY2QtYzg4NjkyMjczYzg2LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDAzMzElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwMzMxVDE3MTEyN1omWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWRjN2EzZTM0OTJkYmY5NDEyNDE5Yzg5MzU2ZmJkOWY2NDExZjFmMTJlNDcyOTAyMzg2OGNlODA1NzBkNTM4MTMmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.DmX9dGS_2xwyh6UpKpIx3aK1rU24wQvPyflxj9RlgV8" alt="操作面板"/>
</p>

📌 **对齐骨骼**: 

- 设置好官方骨架和自定义骨架，点击对齐骨骼，官方骨架的主要骨骼将被自动添加复制位置的骨骼约束，约束的目标骨骼则是在骨骼映射字典里编入过的骨骼
![对齐骨骼](https://private-user-images.githubusercontent.com/46404382/318294620-99973516-a916-4cb4-9a72-0e4131220695.gif?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTE5MTE5OTYsIm5iZiI6MTcxMTkxMTY5NiwicGF0aCI6Ii80NjQwNDM4Mi8zMTgyOTQ2MjAtOTk5NzM1MTYtYTkxNi00Y2I0LTlhNzItMGU0MTMxMjIwNjk1LmdpZj9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDAzMzElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwMzMxVDE5MDEzNlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTE5MmQzMTVmZTg1Y2IzYTExOWRjNThkYTRlZWUwN2FlMDkwZTdhMTc5ZmM1ZGJjZDY0ZDhiNzAzZGVkY2Q0MDAmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.QpBlxRnQk-X2nGGhxSd0-uXXI3VSnvO23t46GLTIOdY)

📌 **骨骼映射管理**: 

- 前面讲到了骨骼映射字典，我们可以先来了解一下它是如何工作的以及该如何编写它。
打开骨骼映射管理，第一栏是官方骨架的主要骨骼列表，每一项骨骼都绑定着第二栏自定义骨列表中的骨骼列表(骨骼名会经过去符号和转小写处理)，比如官骨的盆骨就绑定着hips以及pelvis，这就是对骨和嫁接过程中使用的骨骼映射关系。
<p align="center">
  <img src="https://private-user-images.githubusercontent.com/46404382/318300042-c5405d05-6586-4e56-bebe-cd0bfa2e2109.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTE5NTg2NDEsIm5iZiI6MTcxMTk1ODM0MSwicGF0aCI6Ii80NjQwNDM4Mi8zMTgzMDAwNDItYzU0MDVkMDUtNjU4Ni00ZTU2LWJlYmUtY2QwYmZhMmUyMTA5LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAxVDA3NTkwMVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTE1MzQwOGVjYTk3MDE2MGFlYmFiMjY4Y2FiNGI3YmUzNzA0NTA1ZTRhOTg1OGM2ZGMxNmI0OTZmNjE3ODgxNDYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.0zpAPEnmDCugNo64gwQzpp93uEEhLcdBtKVUXY_KHqw" alt="编写骨骼映射字典"/>
</p>

- 选中自定义骨架并进入姿态模式的时候，会多出第三行"骨骼名称",在第一行"官方骨骼列表"以及这儿选择好需要绑定映射关系的一组官骨和自定义骨，点击添加，我们就可以给当前骨骼映射关系添加一项需要的骨骼名，新增骨骼会在第二栏中立刻刷新展示。这里的设计初衷是为了当有预设字典里没有包含的骨骼名时，也可以自由进行字典的编辑与维护，做到全局操作都在blender中完成。
![插件使用说明](https://private-user-images.githubusercontent.com/46404382/318301303-c8ff0947-97e2-4bab-8b6c-6fa2f08893d2.gif?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTE5MTg2MzMsIm5iZiI6MTcxMTkxODMzMywicGF0aCI6Ii80NjQwNDM4Mi8zMTgzMDEzMDMtYzhmZjA5NDctOTdlMi00YmFiLThiNmMtNmZhMmYwODg5M2QyLmdpZj9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDAzMzElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwMzMxVDIwNTIxM1omWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTQwYTZkMGYxMjk2NGJhYTcyM2U0ODAyYzk4YWNlMzc2Zjc3MTIzMjJlMzYyNGVmNmNkMzNjNTg0MGE0MjI4NWYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.-ipoifGsWQIY3Zkhn40HE6WJTX1CxGef0lh_pqf4H44)

📌 **嫁接骨骼**: 
- 接着讲对齐骨骼后的操作，我们用对齐骨骼创建一批骨骼约束后，先设置一次静置姿势定位姿态，然后移除骨骼约束完成对齐操作的收尾。
![插件使用说明](https://private-user-images.githubusercontent.com/46404382/318387912-300009e7-6cac-4e3d-abcf-da508755421f.gif?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTE5NjE4ODYsIm5iZiI6MTcxMTk2MTU4NiwicGF0aCI6Ii80NjQwNDM4Mi8zMTgzODc5MTItMzAwMDA5ZTctNmNhYy00ZTNkLWFiY2YtZGE1MDg3NTU0MjFmLmdpZj9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAxVDA4NTMwNlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTQ3Yzk4MjcxZjNiYTM5OGU1MDQ1MzYyYjQ0NTM2OWYzYjU3MGIxZWEzN2M5NGZlNGI1YzAzY2FhNmU0ZGE4YjAmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.OBtpPbFW_lIScLjNGV5HP6eHlFXxdH_9O4HFdZGmC5k)
- 从这里开始可以分为两种嫁接流程，一种是先把自定义骨骼重命名为标准官骨命名，然后利用cats插件的合骨把同名骨骼及权重合并至官方骨架中，这个方法可以观看[轻语老师的视频](https://www.bilibili.com/video/BV1414y1U7JX?t=432.4&p=3)，我以上述骨骼映射字典为基础设置了一个<span style="color:red">重命名骨骼</span>的功能用来代替重命名脚本。另一种方法是保留原骨骼重新设置父子级关系。两种方法的区别只有保不保留骨骼，视情况或者喜好来用就行。
- 接下来演示一下这种流程使用的嫁接功能，这个功能有两个主要模式和一个特殊模式。
  1. 当选中某一些骨骼时，只对这些骨骼进行嫁接操作。
  2. 当没有选中骨骼时，默认对全体骨骼进行嫁接操作。
  3. 特别的，当多选骨骼时只要其中包含官骨，则其他骨骼不管有没有存在于映射关系中，均会成为这根官骨的子级。
- 原理仍然是利用了上面设置过的骨骼映射关系，同时还加入了一个距离判定，只要有几乎完全重合的骨骼，就会在其中设置父子级关系。
![插件使用说明](https://private-user-images.githubusercontent.com/46404382/318394691-e4d280ca-c52e-4c7d-8987-7215a74e91e5.gif?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTE5NjM2NzAsIm5iZiI6MTcxMTk2MzM3MCwicGF0aCI6Ii80NjQwNDM4Mi8zMTgzOTQ2OTEtZTRkMjgwY2EtYzUyZS00YzdkLTg5ODctNzIxNWE3NGU5MWU1LmdpZj9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAxVDA5MjI1MFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTYxYmM3YzA3YWNjZmI5ODgxODI5ODBmZGM5YmZjYzg2NWJhYTdmN2ViNzgyYmM3ZDhmMjIxZTQwMjA5ZDcxNGUmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.2uA6ylI1FN0VynTZ11-Gp9Jhwd-phweBNT845J30qbQ)
![插件使用说明](https://private-user-images.githubusercontent.com/46404382/318394705-548a0ece-65fe-496b-8256-62e7a1af180f.gif?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTE5NjM2NzAsIm5iZiI6MTcxMTk2MzM3MCwicGF0aCI6Ii80NjQwNDM4Mi8zMTgzOTQ3MDUtNTQ4YTBlY2UtNjVmZS00OTZiLTgyNTYtNjJlN2ExYWYxODBmLmdpZj9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAxVDA5MjI1MFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTVlMzEyYTMzYTE2YTBiZWRhMTdmZDIzMDcyMmJmN2RlYjMzMzQyZTZkYjBlNTkwMmY3YzI5MmFkMThiMDNlMTUmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.sRgDE_IeVwVxf7XQtwVg-9eA0AHtPuNogXI3QgS3tEU)


📌 **VRD**: 
- 关于借助人物动作辅助生成VRD文本的原理就不讲了，这里主要讲述一下使用插件生成VRD文本的流程过一遍所有VRD功能。
1. 选中需要制作VRD的骨架，点击<span style="color:red">生成VRD动作</span>，会自动为骨骼插帧创建预置的两个名为"VRD"和"VRD_Foot"的动作。其中动作"VRD"包含腿骨和手骨的动作，用来制作裙子VRD以及修正持枪动作。动作"VRD_Foot"包含足骨动作，用来修复穿着高跟鞋的人物IK。当然你自行创建或调整动作也是可以的。剩下的就是在官骨驱动骨骼的动作参考下给程序骨骼插帧了。
2. 完成动作后在VRD项目管理中新建项目，有多少VRD用的动作就新建多少项目，并在列表中的右侧给每一个项目绑定好对应的VRD动作。这里解释一下，因为如果要得到正确的足VRD坐标，全都共用一个动作肯定是不行的，所以才按情况分开处理，也方便以后修改。如果有其他VRD需求也同样注意考虑冲突问题。
3. 新建VRD项目的同时下方会出现两个列表，每个VRD项目会绑定一组程序骨和驱动骨的列表。到这步以后就比较所见即所得了，之后就是自行添加程序骨骼和驱动骨骼，列表左右同一行互相对应。程序骨骼列表每一栏右侧的数字即VRD参数里的第一组角度。
4. 骨骼设置完毕后，在下方设置导出路径，选择想使用的文本类型导出。

📌 **飘骨**: 
- 飘骨工具主要以骨骼列表为中心进行飘骨参数的维护。在列表中添加骨骼之后，选中列表中的任意骨骼，在右侧打开参数面板，下方会弹出各类参数的详细设置，碍于UI面积只做了两大类抖动参数。完成参数设置后，导出的文本会自动输出为能被编译器正确识别的文本格式。下面讲述加强抖动参数编辑效率的一些功能。

1. 骨骼列表左上方全选反选按钮旁边有一个同步按钮，可以让列表的选中状态和3D视图的选中状态同步，方便进行3D视图→列表参数的直观调整，多选状态下每次点击都会跳转至下一项。
2. 同步按钮旁边的预设功能，可以保存当前配置好的抖动参数成为预设。支持给列表多选中的骨骼批量载入预设。
3. 右侧参数面板开关下是参数批量设置按钮，可以多选骨骼批量调整抖动参数数值。也可以通过设置最小最大值智能递增或递减数值。
4. 右侧最后一个按钮可以用来导入从外部文件复制到剪贴板的参数。


📌 **表情**: 
- 表情工具的核心逻辑是基于自定义原模的形态键，通过混合这些形态键变形数值的方式得到适配我们自己面部规则的一套新形态键。而因为MMD模型之间和VRC模型之间的形态键名称一般都是共通的，这正好可以让我们通过记录形态键名称和变形数值的方式，写一套能一直复用的形态键混合字典。


## 鸣谢
- 抹茶芝士✰：对骨脚本&灵感来源
- 残剑斩龙：3DMAX的VRD插件思路
- [SourceOps](https://github.com/bonjorno7/SourceOps)：获取骨骼位置/旋转坐标
- [BoneAnimCopy](https://github.com/kumopult/blender_BoneAnimCopy)：骨骼映射思路
- 发布人物制作教程的作者们

这个插件是为了帮助"求生之路2"的Mod制作者们更高效地进行制作工作。希望这个插件可以使他们的工作变得更轻松。

如果你对插件有任何问题或者建议，欢迎你在Github上提交issue。